<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitoring SPMB Real-time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        .tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
        }
        body {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Overlay Loading -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600 mb-4"></div>
        <p class="text-gray-600 font-medium">Sinkronisasi Data Spreadsheet...</p>
    </div>

    <!-- Modal Setting Pagu -->
    <div id="modal-pagu" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-80">
            <h3 class="font-bold text-lg mb-4">Pengaturan Target (Pagu)</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Pagu SMP</label>
                    <input type="number" id="input-pagu-smp" class="w-full border rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Pagu SMK</label>
                    <input type="number" id="input-pagu-smk" class="w-full border rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <div class="mt-6 flex gap-2">
                <button onclick="togglePaguModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-bold">Batal</button>
                <button onclick="savePagu()" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold">Simpan</button>
            </div>
        </div>
    </div>

    <nav class="bg-indigo-700 text-white p-4 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fas fa-chart-line"></i> Monitoring SPMB Real-time
            </h1>
            <div class="flex gap-4 items-center">
                <button onclick="togglePaguModal()" class="text-sm bg-indigo-600 hover:bg-indigo-500 px-3 py-1 rounded-lg border border-indigo-400 transition-colors">
                    <i class="fas fa-cog"></i> <span class="hidden md:inline ml-1">Set Pagu</span>
                </button>
                <select id="select-tahun-ajaran" onchange="changeTahunAjaran(this.value)" class="bg-indigo-600 text-white text-sm rounded-lg px-3 py-1 outline-none border border-indigo-500">
                    <option value="2025-2026">T.A. 2025-2026</option>
                    <option value="2026-2027">T.A. 2026-2027</option>
                </select>
                <button onclick="fetchData()" class="hover:rotate-180 transition-transform duration-500">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8">
        <!-- Filter Unit -->
        <div class="flex gap-6 mb-8 border-b border-gray-200">
            <button onclick="changeUnit('SMP')" id="btn-SMP" class="pb-2 px-4 font-bold transition-all tab-active">UNIT SMP</button>
            <button onclick="changeUnit('SMK')" id="btn-SMK" class="pb-2 px-4 font-bold text-gray-400 hover:text-indigo-600 transition-all">UNIT SMK</button>
        </div>

        <!-- Statistik Utama -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-blue-500">
                <p class="text-gray-500 text-xs font-semibold uppercase">Total Pendaftar</p>
                <h2 class="text-3xl font-bold text-gray-800" id="stat-total">0</h2>
                <p class="text-xs text-blue-600 mt-2">Pendaftar Masuk</p>
            </div>
            <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-green-500">
                <p class="text-gray-500 text-xs font-semibold uppercase">Lunas Formulir</p>
                <h2 class="text-3xl font-bold text-gray-800" id="stat-formulir">0</h2>
                <p class="text-xs text-green-600 mt-2">Bayar Formulir</p>
            </div>
            <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-purple-500">
                <p class="text-gray-500 text-xs font-semibold uppercase">Lunas DSP</p>
                <h2 class="text-3xl font-bold text-gray-800" id="stat-dsp">0</h2>
                <p class="text-xs text-purple-600 mt-2">Siswa Definitif</p>
            </div>
            <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-orange-500">
                <p class="text-gray-500 text-xs font-semibold uppercase">Sisa Pagu</p>
                <h2 class="text-3xl font-bold text-gray-800" id="stat-pagu">0</h2>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-3">
                    <div id="pagu-progress" class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="glass-card p-6 rounded-2xl shadow-sm lg:col-span-2">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-layer-group text-blue-500"></i> Perolehan per Gelombang
                </h3>
                <div class="relative h-80">
                    <canvas id="chartGelombang"></canvas>
                </div>
            </div>

            <div class="glass-card p-6 rounded-2xl shadow-sm">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-info-circle text-indigo-500"></i> Detail Pembayaran
                </h3>
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>Realisasi Formulir</span>
                            <span id="label-formulir-pct">0%</span>
                        </div>
                        <div class="w-full bg-gray-100 h-2 rounded-full">
                            <div id="bar-formulir" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>Realisasi DSP</span>
                            <span id="label-dsp-pct">0%</span>
                        </div>
                        <div class="w-full bg-gray-100 h-2 rounded-full">
                            <div id="bar-dsp" class="bg-purple-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-8 glass-card p-6 rounded-2xl shadow-sm overflow-hidden">
            <div class="flex flex-col md:flex-row justify-between items-md-center gap-4 mb-6">
                <h3 class="text-lg font-bold">Daftar Pendaftar <span id="table-unit-label">SMP</span> (<span id="table-ta-label">2025-2026</span>)</h3>
                <input type="text" id="search-input" onkeyup="filterTable()" placeholder="Cari nama atau gelombang..." class="text-sm border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none w-full md:w-64">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left" id="main-table">
                    <thead>
                        <tr class="text-gray-400 text-xs uppercase border-b">
                            <th class="pb-3 px-2">Nama Siswa</th>
                            <th class="pb-3 px-2">Gelombang</th>
                            <th class="pb-3 px-2 text-center">Formulir</th>
                            <th class="pb-3 px-2 text-center">DSP</th>
                            <th class="pb-3 px-2 text-right">Status Akhir</th>
                        </tr>
                    </thead>
                    <tbody id="pendaftar-table" class="text-sm divide-y">
                        <!-- Data row akan diisi JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // --- KONFIGURASI ---
        const SPREADSHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTd2mFGVFmIHRuZc7sh9ApfDwp91D3f0F0iMFu3POEwxWx7b8iAmrT40dLs5-SBtVO4LMB4E0BTaXxO/pub?gid=0&single=true&output=csv";
        
        let configPagu = {
            'SMP': parseInt(localStorage.getItem('pagu_smp')) || 80,
            'SMK': parseInt(localStorage.getItem('pagu_smk')) || 260
        };

        let currentUnit = 'SMP';
        let currentTA = '2025-2026';
        let chartInstance = null;
        let allData = [];

        /**
         * Fungsi Parsing CSV yang Lebih Kuat
         * Menangani deteksi delimiter otomatis (koma atau titik koma)
         */
        function parseCSV(csv) {
            const lines = csv.split(/\r?\n/).filter(line => line.trim() !== "");
            if (lines.length === 0) return [];
            
            // Deteksi delimiter: cek apakah baris pertama mengandung lebih banyak koma atau titik koma
            const firstLine = lines[0];
            const commaCount = (firstLine.match(/,/g) || []).length;
            const semiCount = (firstLine.match(/;/g) || []).length;
            const delimiter = commaCount >= semiCount ? "," : ";";

            // Ambil header dan bersihkan (lowercase, hapus tanda petik, hapus spasi)
            const headers = firstLine.split(delimiter).map(h => 
                h.trim().toLowerCase().replace(/['"]+/g, '').replace(/[\u200B-\u200D\uFEFF]/g, "")
            );

            console.log("Headers terdeteksi:", headers);

            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const obj = {};
                const currentline = lines[i].split(delimiter);

                headers.forEach((header, index) => {
                    let value = currentline[index] ? currentline[index].trim().replace(/['"]+/g, '') : "";
                    obj[header] = value;
                });
                result.push(obj);
            }
            return result;
        }

        async function fetchData() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.remove('opacity-0', 'pointer-events-none');
            
            try {
                // Gunakan cache buster untuk data paling update
                const response = await fetch(`${SPREADSHEET_CSV_URL}&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error("Akses ke spreadsheet ditolak.");
                
                const csvText = await response.text();
                allData = parseCSV(csvText);
                
                console.log("Data mentah terbaca:", allData.length, "baris");
                updateDashboard();
            } catch (error) {
                console.error("Fetch Error:", error);
                alert("Data tidak terbaca. Pastikan Spreadsheet sudah di-set ke 'Publish to Web' dengan format CSV.");
            } finally {
                loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        function togglePaguModal() {
            const modal = document.getElementById('modal-pagu');
            document.getElementById('input-pagu-smp').value = configPagu['SMP'];
            document.getElementById('input-pagu-smk').value = configPagu['SMK'];
            modal.classList.toggle('hidden');
        }

        function savePagu() {
            const smpVal = parseInt(document.getElementById('input-pagu-smp').value);
            const smkVal = parseInt(document.getElementById('input-pagu-smk').value);
            
            if(isNaN(smpVal) || isNaN(smkVal)) return alert("Input harus angka");

            configPagu['SMP'] = smpVal;
            configPagu['SMK'] = smkVal;
            localStorage.setItem('pagu_smp', smpVal);
            localStorage.setItem('pagu_smk', smkVal);
            
            togglePaguModal();
            updateDashboard();
        }

        function changeUnit(unit) {
            currentUnit = unit;
            document.getElementById('btn-SMP').className = unit === 'SMP' ? 'pb-2 px-4 font-bold transition-all tab-active' : 'pb-2 px-4 font-bold text-gray-400 hover:text-indigo-600 transition-all';
            document.getElementById('btn-SMK').className = unit === 'SMK' ? 'pb-2 px-4 font-bold transition-all tab-active' : 'pb-2 px-4 font-bold text-gray-400 hover:text-indigo-600 transition-all';
            document.getElementById('table-unit-label').innerText = unit;
            updateDashboard();
        }

        function changeTahunAjaran(ta) {
            currentTA = ta;
            document.getElementById('table-ta-label').innerText = ta;
            updateDashboard();
        }

        function updateDashboard() {
            // Filter berdasarkan Unit dan TA (Case Insensitive)
            const filtered = allData.filter(item => {
                const u = (item.unit || "").toString().trim().toUpperCase();
                const t = (item.ta || "").toString().trim();
                return u === currentUnit && t === currentTA;
            });
            
            const total = filtered.length;
            const lunasFormulir = filtered.filter(i => (i.formulir || "").toLowerCase() === 'lunas').length;
            const lunasDSP = filtered.filter(i => (i.dsp || "").toLowerCase() === 'lunas').length;
            const pagu = configPagu[currentUnit];

            // UI Stats
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-formulir').innerText = lunasFormulir;
            document.getElementById('stat-dsp').innerText = lunasDSP;
            document.getElementById('stat-pagu').innerText = Math.max(0, pagu - lunasDSP);
            
            const paguPct = pagu > 0 ? Math.min((lunasDSP / pagu) * 100, 100) : 0;
            document.getElementById('pagu-progress').style.width = `${paguPct}%`;

            const formPct = total > 0 ? (lunasFormulir / total * 100).toFixed(1) : 0;
            const dspPct = total > 0 ? (lunasDSP / total * 100).toFixed(1) : 0;
            
            document.getElementById('label-formulir-pct').innerText = `${formPct}%`;
            document.getElementById('bar-formulir').style.width = `${formPct}%`;
            document.getElementById('label-dsp-pct').innerText = `${dspPct}%`;
            document.getElementById('bar-dsp').style.width = `${dspPct}%`;

            // Tabel
            const tbody = document.getElementById('pendaftar-table');
            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="py-12 text-center text-gray-400">
                    <i class="fas fa-folder-open text-3xl mb-3 block"></i>
                    Belum ada data untuk ${currentUnit} T.A. ${currentTA}.<br>
                    <span class="text-xs">Periksa kolom 'unit' dan 'ta' di spreadsheet Anda.</span>
                </td></tr>`;
            } else {
                tbody.innerHTML = filtered.map(p => `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-2 font-medium text-gray-700">${p.nama || 'Tanpa Nama'}</td>
                        <td class="py-3 px-2 text-xs text-gray-500 uppercase">${p.gel || '-'}</td>
                        <td class="py-3 px-2 text-center">
                            ${(p.formulir || "").toLowerCase() === 'lunas' ? '<i class="fas fa-check-circle text-green-500 text-lg"></i>' : '<i class="fas fa-clock text-gray-200"></i>'}
                        </td>
                        <td class="py-3 px-2 text-center">
                            ${(p.dsp || "").toLowerCase() === 'lunas' ? '<i class="fas fa-check-circle text-green-500 text-lg"></i>' : '<i class="fas fa-clock text-gray-200"></i>'}
                        </td>
                        <td class="py-3 px-2 text-right">
                            <span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${(p.dsp || "").toLowerCase() === 'lunas' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                ${(p.dsp || "").toLowerCase() === 'lunas' ? 'SISWA DEFINITIF' : 'CALON SISWA'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }

            // Charts
            const eb = filtered.filter(i => (i.gel || "").toLowerCase().includes('early')).length;
            const g1 = filtered.filter(i => (i.gel || "").toLowerCase().includes('1')).length;
            const g2 = filtered.filter(i => (i.gel || "").toLowerCase().includes('2')).length;
            updateChart([eb, g1, g2]);
        }

        function updateChart(dataValues) {
            const ctx = document.getElementById('chartGelombang').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Early Bird', 'Gelombang 1', 'Gelombang 2'],
                    datasets: [{
                        data: dataValues,
                        backgroundColor: ['#4f46e5', '#3b82f6', '#10b981'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, ticks: { stepSize: 1, color: '#9ca3af' }, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false }, ticks: { color: '#6b7280', font: { weight: 'bold' } } }
                    }
                }
            });
        }

        function filterTable() {
            const input = document.getElementById("search-input").value.toUpperCase();
            const rows = document.getElementById("pendaftar-table").getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                const text = rows[i].textContent || rows[i].innerText;
                if (text.includes("Belum ada data")) continue;
                rows[i].style.display = text.toUpperCase().indexOf(input) > -1 ? "" : "none";
            }
        }

        window.onload = fetchData;
    </script>
</body>
</html>
